generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model Order {
  id                     String                  @id @default(cuid())
  email                  String
  name                   String
  phone                  String?
  productType            String                  // BOOK | COACHING | BUNDLE | EVENT
  productName            String
  amount                 Float
  currency               String                  // KES | USD | GBP
  paymentMethod          String                  // STRIPE | MPESA | FREE | PAYPAL
  paymentId              String?
  status                 String                  @default("PENDING") // PENDING | PAID | FAILED | REFUNDED
  downloadToken          String?                 @unique
  tokenExpiresAt         DateTime?
  calendlyUrl            String?
  couponCode             String?
  discountAmount         Float?                  @default(0)
  paymentType            String                  @default("ONE_TIME") // ONE_TIME | INSTALLMENT
  stripeSessionId        String?
  stripeSubscriptionId   String?
  refundedAt             DateTime?
  refundStatus           String?                 // REFUNDED | PARTIAL
  tierId                 String?
  tier                   TicketTier?             @relation(fields: [tierId], references: [id])
  registration           EventRegistration?
  installmentSubscription InstallmentSubscription?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
}

model InstallmentSubscription {
  id                   String   @id @default(cuid())
  orderId              String   @unique
  order                Order    @relation(fields: [orderId], references: [id])
  stripeSubscriptionId String   @unique
  totalInstallments    Int
  paidInstallments     Int      @default(0)
  status               String   @default("ACTIVE") // ACTIVE | COMPLETED | FAILED | CANCELED
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Event {
  id             String              @id @default(cuid())
  title          String
  slug           String              @unique
  description    String?
  shortDesc      String?
  coverImage     String?
  eventType      String              @default("ONLINE") // ONLINE | IN_PERSON | HYBRID
  isRecurring    Boolean             @default(false)
  timezone       String              @default("Africa/Nairobi")
  meetingLink    String?
  meetingDetails String?
  extraDetails   String?
  calendlyUrl    String?
  isActive       Boolean             @default(true)
  order          Int                 @default(0)
  tiers          TicketTier[]
  sessions       EventSession[]
  registrations  EventRegistration[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}

model TicketTier {
  id                  String              @id @default(cuid())
  eventId             String
  event               Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name                String
  description         String?
  priceUSD            Float               @default(0)
  priceGBP            Float               @default(0)
  priceKES            Float               @default(0)
  originalPriceUSD    Float?
  originalPriceGBP    Float?
  originalPriceKES    Float?
  quantityAvailable   Int                 @default(0) // 0 = unlimited
  soldCount           Int                 @default(0)
  maxPerPurchase      Int                 @default(5)
  isSaleClosed        Boolean             @default(false)
  isDefault           Boolean             @default(false)
  order               Int                 @default(0)
  orders              Order[]
  registrations       EventRegistration[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

model EventSession {
  id            String   @id @default(cuid())
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sessionNumber Int      @default(1)
  title         String?
  startTime     DateTime
  endTime       DateTime?
  timezone      String   @default("Africa/Nairobi")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model EventRegistration {
  id              String      @id @default(cuid())
  orderId         String      @unique
  order           Order       @relation(fields: [orderId], references: [id])
  eventId         String
  event           Event       @relation(fields: [eventId], references: [id])
  tierId          String
  tier            TicketTier  @relation(fields: [tierId], references: [id])
  seatCount       Int         @default(1)
  reminderSent    Boolean     @default(false)
  reminderSentAt  DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model BookResource {
  id          String       @id @default(cuid())
  title       String
  slug        String       @unique
  fileName    String
  description String?
  priceUSD    Float?
  priceKES    Float?
  publisher   String?
  coverImage  String?
  currency    String?
  isActive    Boolean      @default(true)
  order       Int          @default(0)
  bundleItems BundleItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model CoachingSession {
  id           String    @id @default(cuid())
  title        String
  description  String?
  clientName   String?
  clientEmail  String?
  status       String    @default("UPCOMING")
  scheduledAt  DateTime?
  recordingUrl String?
  duration     Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Coupon {
  id           String    @id @default(cuid())
  code         String    @unique
  type         String    // PERCENT | FIXED_USD | FIXED_KES
  value        Float
  minAmountUSD Float?
  maxUses      Int?
  usedCount    Int       @default(0)
  appliesTo    String?   // BOOK | COACHING | BUNDLE | null = all
  expiresAt    DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Bundle {
  id          String       @id @default(cuid())
  title       String
  slug        String       @unique
  description String?
  priceUSD    Float
  priceKES    Float
  coverImage  String?
  isActive    Boolean      @default(true)
  order       Int          @default(0)
  items       BundleItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model BundleItem {
  id       String       @id @default(cuid())
  bundleId String
  bookId   String
  bundle   Bundle       @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  book     BookResource @relation(fields: [bookId], references: [id])

  @@unique([bundleId, bookId])
}

model Publication {
  id          String   @id @default(cuid())
  type        String   // BOOK_CHAPTER | FILM_MEDIA | REPORT | LECTURE
  year        String
  title       String
  description String?
  publisher   String?
  link        String?
  tags        String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MediaItem {
  id          String   @id @default(cuid())
  category    String   // INTERVIEW | BLOG | VIDEO | PHOTO
  title       String
  description String?
  source      String?
  url         String?
  date        String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SpiritualCoaching {
  id          String   @id @default(cuid())
  title       String
  description String?
  duration    String?
  price       String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Client {
  id           String   @id @default(cuid())
  name         String
  organization String?
  country      String?
  description  String?
  isActive     Boolean  @default(true)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
